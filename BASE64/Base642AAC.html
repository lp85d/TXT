<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Base64 Audio Repair & Download</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        textarea { width: 100%; height: 150px; margin-bottom: 10px; font-family: monospace; font-size: 12px; }
        .controls { margin-top: 15px; padding: 15px; border: 1px solid #ccc; background: #f9f9f9; border-radius: 5px;}
        button { cursor: pointer; padding: 10px 20px; font-size: 16px; background-color: #007BFF; color: white; border: none; border-radius: 4px; }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #545b62; }
        input { padding: 8px; width: 200px; font-size: 14px; }
        audio { vertical-align: middle; margin-left: 10px; width: 100%; margin-top: 10px; }
    </style>
</head>
<body>

    <h2>Base64: –ü–æ—á–∏–Ω–∏—Ç—å –∏ –°–∫–∞—á–∞—Ç—å –±–∏—Ç—É—é AAC</h2>
    <p>–í—Å—Ç–∞–≤—å—Ç–µ "–±–∏—Ç—É—é" –∏–ª–∏ –¥–ª–∏–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É Base64:</p>
    
    <textarea id="base64Str" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ Base64 —Å—Ç—Ä–æ–∫—É..."></textarea>

    <div class="controls">
        <h3>1. –ü—Ä–æ—Å–ª—É—à–∞—Ç—å (—Å –∞–≤—Ç–æ-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º)</h3>
        <button class="secondary" onclick="playAudio()">‚ñ∂ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –ø–ª–µ–µ—Ä</button>
        <br>
        <audio id="audioPlayer" controls></audio>
    </div>

    <div class="controls">
        <h3>2. –°–∫–∞—á–∞—Ç—å (Blob –º–µ—Ç–æ–¥)</h3>
        <input type="text" id="fileName" value="audio.mp3" placeholder="–ò–º—è —Ñ–∞–π–ª–∞">
        <button onclick="downloadLargeFile()">üíæ –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</button>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –º—É—Å–æ—Ä–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏ (–ø—Ä–æ–±–µ–ª—ã, –ø–µ—Ä–µ–Ω–æ—Å—ã –∏ —Ç.–¥.)
        function cleanBase64(input) {
            // 1. –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ data:..., –æ—Ç—Ä–µ–∑–∞–µ–º –µ–≥–æ, –±–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
            if (input.includes(',')) {
                input = input.split(',')[1];
            }
            // 2. –£–¥–∞–ª—è–µ–º –í–°–ï —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è Base64 (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ A-Z, a-z, 0-9, +, /, =)
            return input.replace(/[^A-Za-z0-9+/=]/g, "");
        }

        function b64toBlob(b64Data, contentType='', sliceSize=512) {
            const byteCharacters = atob(b64Data);
            const byteArrays = [];

            for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                const slice = byteCharacters.slice(offset, offset + sliceSize);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }

            const blob = new Blob(byteArrays, {type: contentType});
            return blob;
        }

        function playAudio() {
            const raw = document.getElementById('base64Str').value;
            if (!raw) return alert("–í—Å—Ç–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É!");

            try {
                const cleaned = cleanBase64(raw);
                // –°–æ–∑–¥–∞–µ–º Blob –¥–ª—è –ø–ª–µ–µ—Ä–∞, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å –ø–∞–º—è—Ç—å —Å—Å—ã–ª–∫–æ–π
                const blob = b64toBlob(cleaned, 'audio/mpeg'); 
                const blobUrl = URL.createObjectURL(blob);
                
                const player = document.getElementById('audioPlayer');
                player.src = blobUrl;
                player.play();
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è! –í–æ–∑–º–æ–∂–Ω–æ —Å—Ç—Ä–æ–∫–∞ —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞.\n" + e.message);
            }
        }

        function downloadLargeFile() {
            const raw = document.getElementById('base64Str').value;
            const fileName = document.getElementById('fileName').value || 'download.bin';

            if (!raw) return alert("–ü–æ–ª–µ –ø—É—Å—Ç–æ–µ!");

            try {
                // 1. –ß–∏—Å—Ç–∏–º —Å—Ç—Ä–æ–∫—É –æ—Ç "–±–∏—Ç—ã—Ö" —Å–∏–º–≤–æ–ª–æ–≤
                const cleaned = cleanBase64(raw);
                
                // 2. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –±–∏–Ω–∞—Ä–Ω—ã–π Blob (—ç—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤)
                const blob = b64toBlob(cleaned, 'application/octet-stream');
                
                // 3. –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ Blob
                const blobUrl = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                
                // 4. –£–±–∏—Ä–∞–µ–º –º—É—Å–æ—Ä
                document.body.removeChild(link);
                URL.revokeObjectURL(blobUrl);
                
            } catch (e) {
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å Base64.\n–û—à–∏–±–∫–∞: " + e.message);
            }
        }
    </script>
</body>
</html>
